<header>
  <a href="https://www.epic1h.com" target="_blank">
    <img alt="Epic One Hour" src="assets/epic1h.svg" width="150" height="28">
  </a>
</header>

<div class="me">
  {{me.avatar | avatar}}
</div>

<ng-container *ngFor="let t of tokens;let line = index">
  <div *ngIf="t.type !== 'space'"
       class="token"
       [class.first]="line === 0"
       [class.opened]="channel.progress[me.id] >= line"
       [class.unlocked]="!channel.locked || channel.progress[channel.owner] >= line"
       [attr.data-type]="t.type">
    <div *ngIf="!channel.locked || me.id !== channel.owner" class="open">
      <button
        (click)="setProgress(channel.locked ? channel.progress[channel.owner] : findChapter(channel.progress[me.id] || 0))">

        <svg *ngIf="line === 0" width="41" height="59" viewBox="0 0 41 59" fill="coral"
             xmlns="http://www.w3.org/2000/svg">
          <path
            d="M36.4213 28.3093H36.1338C35.5001 28.3093 34.898 28.4485 34.3571 28.6979C33.9419 26.7807 32.2329 25.3404 30.1932 25.3404H29.9051C29.1779 25.3404 28.4933 25.5234 27.8937 25.8457C27.2491 24.3125 25.7309 23.2331 23.9652 23.2331H23.677C23.0807 23.2331 22.5121 23.3562 21.997 23.5785V17.4834C21.997 15.1351 20.0862 13.2256 17.7371 13.2256H17.4489C15.1004 13.2256 13.1896 15.1358 13.1896 17.4834V33.1181L11.2524 34.5881C9.70909 35.759 8.73114 37.4629 8.49777 39.3853C8.2644 41.3083 8.80656 43.1965 10.0256 44.7025L16.0713 52.1741V55.1437C16.0713 56.9423 17.5353 58.4065 19.3345 58.4065H34.4267C36.226 58.4065 37.6907 56.943 37.6907 55.1437L37.6913 52.3243C39.6227 49.8973 40.6819 46.8865 40.6819 43.7907V32.5671C40.6806 30.2195 38.7705 28.3093 36.4213 28.3093ZM38.1019 43.79C38.1019 46.4335 37.1491 49.0022 35.4208 51.0232C35.2203 51.2565 35.1114 51.5536 35.1114 51.8609V55.1437C35.1114 55.5214 34.8039 55.8287 34.4261 55.8287H19.3345C18.9574 55.8287 18.6499 55.5214 18.6499 55.1437V51.7179C18.6499 51.4227 18.5487 51.1366 18.363 50.9072L12.0305 43.0811C11.2543 42.1222 10.9088 40.9197 11.0577 39.6953C11.206 38.4715 11.8294 37.3862 12.8118 36.6406L13.1896 36.3545V39.8957C13.1896 40.6071 13.7672 41.1846 14.4789 41.1846C15.1907 41.1846 15.7683 40.6071 15.7683 39.8957V33.7697C15.7683 33.7606 15.7683 33.7529 15.7683 33.7439V17.4828C15.7683 16.5561 16.5219 15.8027 17.4489 15.8027H17.7371C18.6641 15.8027 19.4177 16.5567 19.4177 17.4828V27.4909C19.4177 27.4909 19.4177 27.4909 19.4177 27.4915C19.4177 27.4922 19.4177 27.4915 19.4177 27.4922L19.4241 35.8164C19.4248 36.5278 20.0018 37.104 20.7135 37.104H20.7141C21.4258 37.1033 22.0028 36.5266 22.0022 35.8138L21.9964 27.4909C21.9964 26.5642 22.75 25.8109 23.6763 25.8109H23.9645C24.8915 25.8109 25.6451 26.5648 25.6451 27.4909L25.6509 35.8164C25.6516 36.5278 26.2286 37.104 26.9403 37.104C26.9409 37.104 26.9409 37.104 26.9416 37.104C27.6533 37.1033 28.2302 36.5259 28.2296 35.8138L28.2238 29.5976C28.2238 28.6709 28.9774 27.9175 29.9038 27.9175H30.1919C31.119 27.9175 31.8726 28.6715 31.8726 29.5976V32.232C31.8687 32.2746 31.8597 32.3158 31.8597 32.359L31.8661 35.817C31.8674 36.5285 32.4444 37.1033 33.1555 37.1033C33.1561 37.1033 33.1567 37.1033 33.158 37.1033C33.8697 37.102 34.4461 36.524 34.4448 35.8119L34.439 32.6851C34.4428 32.6451 34.4512 32.6071 34.4512 32.5665C34.4512 31.6398 35.2055 30.8864 36.1319 30.8864H36.4194C37.3464 30.8864 38.1 31.6404 38.1 32.5665V43.79H38.1019Z"/>
          <path
            d="M32.926 16.8467H25.0585C24.3468 16.8467 23.7692 16.2693 23.7692 15.5579C23.7692 14.8464 24.3468 14.269 25.0585 14.269H32.926C33.6377 14.269 34.2153 14.8464 34.2153 15.5579C34.2153 16.2693 33.6383 16.8467 32.926 16.8467Z"/>
          <path
            d="M17.4483 10.849C16.7366 10.849 16.1589 10.2715 16.1589 9.56008V1.69537C16.1589 0.98391 16.7366 0.406494 17.4483 0.406494C18.16 0.406494 18.7376 0.98391 18.7376 1.69537V9.56008C18.7376 10.2722 18.1606 10.849 17.4483 10.849Z"/>
          <path
            d="M22.9749 12.2906C22.6449 12.2906 22.3155 12.1649 22.0634 11.9129C21.5599 11.4096 21.5599 10.5938 22.0634 10.0905L27.6268 4.5296C28.1303 4.0263 28.9465 4.0263 29.4499 4.5296C29.9534 5.03291 29.9534 5.84877 29.4499 6.35207L23.8865 11.9129C23.6344 12.1649 23.3044 12.2906 22.9749 12.2906Z"/>
          <path
            d="M9.83867 16.8467H1.97121C1.2595 16.8467 0.681885 16.2693 0.681885 15.5579C0.681885 14.8464 1.2595 14.269 1.97121 14.269H9.83867C10.5504 14.269 11.128 14.8464 11.128 15.5579C11.128 16.2693 10.5504 16.8467 9.83867 16.8467Z"/>
          <path
            d="M11.9222 12.2906C11.5921 12.2906 11.2621 12.1649 11.0107 11.9129L5.44787 6.35207C4.94439 5.84877 4.94439 5.03291 5.44787 4.5296C5.95071 4.0263 6.76814 4.0263 7.27098 4.5296L12.8338 10.0905C13.3372 10.5938 13.3372 11.4096 12.8338 11.9129C12.5823 12.1649 12.2523 12.2906 11.9222 12.2906Z"/>
        </svg>

        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div class="marks" [class.marked]="!!channel.marks[me.id][line]">
      <div class="my">
        <ng-container *ngIf="channel.marks[me.id][line] as mark">
          {{mark | mark}}
        </ng-container>
      </div>
      <div class="tools">
        <div class="content">
          <div class="buttons">
            <button [class.marked]="channel.marks[me.id][line] === 'problem'"
                    (click)="putMark(line, channel.marks[me.id][line] !== 'problem' ? 'problem' : null)">
              üî•
            </button>
            <button [class.marked]="channel.marks[me.id][line] === 'shit'"
                    (click)="putMark(line, channel.marks[me.id][line] !== 'shit' ? 'shit' : null)">
              üí©
            </button>
            <button [class.marked]="channel.marks[me.id][line] === 'like'"
                    (click)="putMark(line, channel.marks[me.id][line] !== 'like' ? 'like' : null)">
              üëç
            </button>
          </div>
          <textarea [formControl]="getCommentControl(line)"
                    placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π"></textarea>
        </div>
      </div>

      <div class="progress"></div>
    </div>

    <div class="md">
      <div class="content">
        <ng-container [ngSwitch]="t.type">

          <ng-template #chapterTemplate>
            <hr>
          </ng-template>

          <ng-container *ngSwitchCase="'hr'">
            <ng-container *ngIf="channel.locked">
              <button class="unlock" *ngIf="t.type === 'hr' && me.id === channel.owner;else chapterTemplate"
                      (dblclick)="setProgress(tokens.length - 1)"
                      (click)="setProgress(line)">
                <hr>
              </button>
            </ng-container>
          </ng-container>

          <ng-container *ngSwitchCase="'poll'">
            <p>{{t.question}}?</p>
            <ul class="poll">
              <li *ngFor="let o of t.options;let j = index"
                  [class.selected]="channel.polls[me.id] && channel.polls[me.id][line] === j">
                <span (click)="votePoll(line,  j)">{{o}}</span>
                <ng-container *ngIf="channel.polls[me.id]">
                  <ng-container *ngIf="(channel | voted:me:line:j) as voted">
                    <div class="votes" *ngIf="voted.length > 0">
                      <span *ngFor="let m of voted" title="m.name">{{m.avatar | avatar}}</span>
                    </div>
                  </ng-container>
                </ng-container>
              </li>
            </ul>
          </ng-container>

          <ng-container *ngSwitchCase="'timer'">
            <app-timer [id]="line"
                       [time]="t.time"
                       [manage]="me.id === channel.owner"
                       (started)="startTimer(line, $event)"
                       (stopped)="stopTimer(line, $event)">
            </app-timer>
          </ng-container>
          <div *ngSwitchDefault [outerHTML]="t | token2Html"></div>
        </ng-container>

        <div class="members">
          <ng-container *ngFor="let member of channel.members | keyvalue">
            <ng-container *ngIf="member.key !== me.id">
              <div *ngIf="channel.marks[member.key][line] as mark"
                   [attr.title]="member.value.name">
                {{member.value.avatar | avatar}}
                <span>{{mark | mark}}</span>
              </div>
            </ng-container>
          </ng-container>
        </div>
        <div class="progress">
          <ng-container *ngFor="let m of channel.members | keyvalue">
            <div *ngIf="m.key !== channel.owner && m.key !== me.id && channel.progress[m.key] === line">
              {{m.value.avatar | avatar}}
            </div>
          </ng-container>
        </div>
        <div class="comments">
          <ng-container *ngFor="let comment of (channel.comments[line] | keyvalue)">
            <div *ngIf="channel.members[comment.key] as member">
              <b>{{member.avatar | avatar}} {{member.name}}</b>
              <div [outerHTML]="comment.value | md2Html"></div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<p>
  <small>–ü—Ä–∞–≤–∞ –≤–æ–æ–±—â–µ –Ω–µ –∑–∞—â–∏—â–µ–Ω—ã! –ü–æ–ª—å–∑—É–π—Ç–µ—Å—å –Ω–∞ –∑–¥–æ—Ä–æ–≤—å–µ üòÇ</small>
</p>
